window.bp=window.bp||{};(function(exports,$){if(typeof SZ_Uploader==="undefined"){return}bp.Models=bp.Models||{};bp.Collections=bp.Collections||{};bp.Views=bp.Views||{};bp.Avatar={start:function(){var self=this;this.removeLegacyUI();this.views=new Backbone.Collection;this.jcropapi={};this.warning=null;this.setupNav();this.avatars=bp.Uploader.filesUploaded;this.Attachment=new Backbone.Model;bp.Uploader.filesQueue.on("reset",this.cropView,this);$("body.wp-admin").on("tb_unload","#TB_window",function(){self.resetViews()});$("body.wp-admin").on("click",".sz-xprofile-avatar-user-edit",function(){self.resetViews()})},removeLegacyUI:function(){if($("#avatar-upload-form").length){$("#avatar-upload").remove();$("#avatar-upload-form p").remove()}else if($("#group-settings-form").length){$("#group-settings-form p").each(function(i){if(0!==i){$(this).remove()}});if($("#delete-group-avatar-button").length){$("#delete-group-avatar-button").remove()}}else if($("#group-create-body").length){$(".main-column p #file").remove();$(".main-column p #upload").remove()}else if($("#sz_xprofile_user_admin_avatar a.sz-xprofile-avatar-user-admin").length){$("#sz_xprofile_user_admin_avatar a.sz-xprofile-avatar-user-admin").remove()}},setView:function(view){if(!_.isUndefined(this.views.models)){_.each(this.views.models,function(model){model.get("view").remove()},this)}this.views.reset();if(!_.isUndefined(this.avatars)){this.avatars.reset()}if(!_.isEmpty(this.jcropapi)){this.jcropapi.destroy();this.jcropapi={}}switch(view){case"upload":this.uploaderView();break;case"delete":this.deleteView();break}},resetViews:function(){this.nav.trigger("sz-avatar-view:changed","upload");_.each(this.navItems.models,function(model){if(model.id==="upload"){model.set({active:1})}else{model.set({active:0})}})},setupNav:function(){var self=this,initView,activeView;this.navItems=new Backbone.Collection;_.each(SZ_Uploader.settings.nav,function(item,index){if(!_.isObject(item)){return}activeView=0;if(0===index){initView=item.id;activeView=1}self.navItems.add({id:item.id,name:item.caption,href:"#",active:activeView,hide:_.isUndefined(item.hide)?0:item.hide})});this.nav=new bp.Views.Nav({collection:this.navItems});this.nav.inject(".sz-avatar-nav");this.setView(initView);this.nav.on("sz-avatar-view:changed",_.bind(this.setView,this))},uploaderView:function(){bp.Uploader.filesQueue.on("add",this.uploadProgress,this);var uploader=new bp.Views.Uploader;this.views.add({id:"upload",view:uploader});uploader.inject(".sz-avatar")},uploadProgress:function(){var avatarStatus=new bp.Views.uploaderStatus({collection:bp.Uploader.filesQueue});if(!_.isUndefined(this.views.get("status"))){this.views.set({id:"status",view:avatarStatus})}else{this.views.add({id:"status",view:avatarStatus})}avatarStatus.inject(".sz-avatar-status")},cropView:function(){var status;if(_.isEmpty(this.avatars.models)){return}if(!_.isUndefined(this.views.get("status"))){status=this.views.get("status");status.get("view").remove();this.views.remove({id:"status",view:status})}var avatar=new bp.Views.Avatars({collection:this.avatars});this.views.add({id:"crop",view:avatar});avatar.inject(".sz-avatar")},setAvatar:function(avatar){var self=this,crop;if(!_.isUndefined(this.views.get("crop"))){if(!_.isEmpty(this.jcropapi)){this.jcropapi.destroy();this.jcropapi={}}crop=this.views.get("crop");crop.get("view").remove();this.views.remove({id:"crop",view:crop})}bp.ajax.post("sz_avatar_set",{json:true,original_file:avatar.get("url"),crop_w:avatar.get("w"),crop_h:avatar.get("h"),crop_x:avatar.get("x"),crop_y:avatar.get("y"),item_id:avatar.get("item_id"),object:avatar.get("object"),type:_.isUndefined(avatar.get("type"))?"crop":avatar.get("type"),nonce:avatar.get("nonces").set}).done(function(response){var avatarStatus=new bp.Views.AvatarStatus({value:SZ_Uploader.strings.feedback_messages[response.feedback_code],type:"success"});self.views.add({id:"status",view:avatarStatus});avatarStatus.inject(".sz-avatar-status");$("."+avatar.get("object")+"-"+response.item_id+"-avatar").each(function(){$(this).prop("src",response.avatar)});bp.Avatar.navItems.get("delete").set({hide:0});self.Attachment.set(_.extend(_.pick(avatar.attributes,["object","item_id"]),{url:response.avatar,action:"uploaded"}))}).fail(function(response){var feedback=SZ_Uploader.strings.default_error;if(!_.isUndefined(response)){feedback=SZ_Uploader.strings.feedback_messages[response.feedback_code]}var avatarStatus=new bp.Views.AvatarStatus({value:feedback,type:"error"});self.views.add({id:"status",view:avatarStatus});avatarStatus.inject(".sz-avatar-status")})},deleteView:function(){var delete_model=new Backbone.Model(_.pick(SZ_Uploader.settings.defaults.multipart_params.sz_params,"object","item_id","nonces"));var deleteView=new bp.Views.DeleteAvatar({model:delete_model});this.views.add({id:"delete",view:deleteView});deleteView.inject(".sz-avatar")},deleteAvatar:function(model){var self=this,deleteView;if(!_.isUndefined(this.views.get("delete"))){deleteView=this.views.get("delete");deleteView.get("view").remove();this.views.remove({id:"delete",view:deleteView})}bp.ajax.post("sz_avatar_delete",{json:true,item_id:model.get("item_id"),object:model.get("object"),nonce:model.get("nonces").remove}).done(function(response){var avatarStatus=new bp.Views.AvatarStatus({value:SZ_Uploader.strings.feedback_messages[response.feedback_code],type:"success"});self.views.add({id:"status",view:avatarStatus});avatarStatus.inject(".sz-avatar-status");$("."+model.get("object")+"-"+response.item_id+"-avatar").each(function(){$(this).prop("src",response.avatar)});bp.Avatar.navItems.get("delete").set({active:0,hide:1});self.Attachment.set(_.extend(_.pick(model.attributes,["object","item_id"]),{url:response.avatar,action:"deleted"}))}).fail(function(response){var feedback=SZ_Uploader.strings.default_error;if(!_.isUndefined(response)){feedback=SZ_Uploader.strings.feedback_messages[response.feedback_code]}var avatarStatus=new bp.Views.AvatarStatus({value:feedback,type:"error"});self.views.add({id:"status",view:avatarStatus});avatarStatus.inject(".sz-avatar-status")})},removeWarning:function(){if(!_.isNull(this.warning)){this.warning.remove()}},displayWarning:function(message){this.removeWarning();this.warning=new bp.Views.uploaderWarning({value:message});this.warning.inject(".sz-avatar-status")}};bp.Views.Nav=bp.View.extend({tagName:"ul",className:"avatar-nav-items",events:{"click .sz-avatar-nav-item":"toggleView"},initialize:function(){var hasAvatar=_.findWhere(this.collection.models,{id:"delete"});console.log(hasAvatar);if(1!==hasAvatar.get("hide")){bp.Avatar.displayWarning(SZ_Uploader.strings.has_avatar_warning)}_.each(this.collection.models,this.addNavItem,this);this.collection.on("change:hide",this.showHideNavItem,this)},addNavItem:function(item){if(1===item.get("hide")){return}this.views.add(new bp.Views.NavItem({model:item}))},showHideNavItem:function(item){var isRendered=null;_.each(this.views._views[""],function(view){if(1===view.model.get("hide")){view.remove()}if(item.get("id")===view.model.get("id")){isRendered=true}});if(!_.isBoolean(isRendered)){this.addNavItem(item)}},toggleView:function(event){event.preventDefault();bp.Avatar.removeWarning();var active=$(event.target).data("nav");_.each(this.collection.models,function(model){if(model.id===active){model.set({active:1});this.trigger("sz-avatar-view:changed",model.id)}else{model.set({active:0})}},this)}});bp.Views.NavItem=bp.View.extend({tagName:"li",className:"avatar-nav-item",template:bp.template("sz-avatar-nav"),initialize:function(){if(1===this.model.get("active")){this.el.className+=" current"}this.el.id+="sz-avatar-"+this.model.get("id");this.model.on("change:active",this.setCurrentNav,this)},setCurrentNav:function(model){if(1===model.get("active")){this.$el.addClass("current")}else{this.$el.removeClass("current")}}});bp.Views.Avatars=bp.View.extend({className:"items",initialize:function(){_.each(this.collection.models,this.addItemView,this)},addItemView:function(item){var full_d={full_h:150,full_w:150};if(!_.isUndefined(SZ_Uploader.settings.crop.full_h)&&!_.isUndefined(SZ_Uploader.settings.crop.full_w)){full_d.full_h=SZ_Uploader.settings.crop.full_h;full_d.full_w=SZ_Uploader.settings.crop.full_w}item.set(_.extend(_.pick(SZ_Uploader.settings.defaults.multipart_params.sz_params,"object","item_id","nonces"),full_d));this.views.add(new bp.Views.Avatar({model:item}))}});bp.Views.Avatar=bp.View.extend({className:"item",template:bp.template("sz-avatar-item"),events:{"click .avatar-crop-submit":"cropAvatar"},initialize:function(){_.defaults(this.options,{full_h:SZ_Uploader.settings.crop.full_h,full_w:SZ_Uploader.settings.crop.full_w,aspectRatio:1});if(false!==this.model.get("feedback")){bp.Avatar.displayWarning(this.model.get("feedback"))}this.on("ready",this.initCropper)},initCropper:function(){var self=this,tocrop=this.$el.find("#avatar-to-crop img"),availableWidth=this.$el.width(),selection={},crop_top,crop_bottom,crop_left,crop_right,nh,nw;if(!_.isUndefined(this.options.full_h)&&!_.isUndefined(this.options.full_w)){this.options.aspectRatio=this.options.full_w/this.options.full_h}selection.w=this.model.get("width");selection.h=this.model.get("height");if(this.options.full_w+selection.w+20<availableWidth){$("#avatar-to-crop").addClass("adjust");this.$el.find(".avatar-crop-management").addClass("adjust")}if(selection.h<=selection.w){crop_top=Math.round(selection.h/4);nh=nw=Math.round(selection.h/2);crop_bottom=nh+crop_top;crop_left=(selection.w-nw)/2;crop_right=nw+crop_left}else{crop_left=Math.round(selection.w/4);nh=nw=Math.round(selection.w/2);crop_right=nw+crop_left;crop_top=(selection.h-nh)/2;crop_bottom=nh+crop_top}tocrop.Jcrop({onChange:_.bind(self.showPreview,self),onSelect:_.bind(self.showPreview,self),aspectRatio:self.options.aspectRatio,setSelect:[crop_left,crop_top,crop_right,crop_bottom]},function(){bp.Avatar.jcropapi=this})},cropAvatar:function(event){event.preventDefault();bp.Avatar.setAvatar(this.model)},showPreview:function(coords){if(!coords.w||!coords.h){return}if(parseInt(coords.w,10)>0){var fw=this.options.full_w;var fh=this.options.full_h;var rx=fw/coords.w;var ry=fh/coords.h;this.model.set({x:coords.x,y:coords.y,w:coords.w,h:coords.h});$("#avatar-crop-preview").css({maxWidth:"none",width:Math.round(rx*this.model.get("width"))+"px",height:Math.round(ry*this.model.get("height"))+"px",marginLeft:"-"+Math.round(rx*this.model.get("x"))+"px",marginTop:"-"+Math.round(ry*this.model.get("y"))+"px"})}}});bp.Views.AvatarStatus=bp.View.extend({tagName:"p",className:"updated",id:"sz-avatar-feedback",initialize:function(){this.el.className+=" "+this.options.type;this.value=this.options.value},render:function(){this.$el.html(this.value);return this}});bp.Views.DeleteAvatar=bp.View.extend({tagName:"div",id:"sz-delete-avatar-container",template:bp.template("sz-avatar-delete"),events:{"click #sz-delete-avatar":"deleteAvatar"},deleteAvatar:function(event){event.preventDefault();bp.Avatar.deleteAvatar(this.model)}});bp.Avatar.start()})(bp,jQuery);