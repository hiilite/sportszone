window.wp=window.wp||{};window.bp=window.bp||{};(function(exports,$){if(typeof SZ_Uploader==="undefined"){return}_.extend(bp,_.pick(wp,"Backbone","ajax","template"));bp.Models=bp.Models||{};bp.Collections=bp.Collections||{};bp.Views=bp.Views||{};bp.Uploader={};bp.Uploader.uploader=function(){var self=this,isIE=navigator.userAgent.indexOf("Trident/")!==-1||navigator.userAgent.indexOf("MSIE ")!==-1;this.params=SZ_Uploader.settings;this.strings=SZ_Uploader.strings;this.supports={upload:this.params.browser.supported};this.supported=this.supports.upload;if(!this.supported){SZ_Uploader=undefined;return}if(!isIE&&"flash"===plupload.predictRuntime(this.params.defaults)&&(!this.params.defaults.required_features||!this.params.defaults.required_features.hasOwnProperty("send_binary_string"))){this.params.defaults.required_features=this.params.defaults.required_features||{};this.params.defaults.required_features.send_binary_string=true}this.uploader=new plupload.Uploader(this.params.defaults);this.uploader.bind("Init",function(uploader){var container=$("#"+self.params.defaults.container),drop_element=$("#"+self.params.defaults.drop_element);if("html4"===uploader.runtime){uploader.settings.multipart_params.html4=true}if("sz_avatar_upload"===uploader.settings.multipart_params.action){uploader.settings.multipart_params.sz_params.ui_available_width=container.width()}if("sz_cover_image_upload"===uploader.settings.multipart_params.action){uploader.settings.multipart_params.sz_params.ui_available_width=container.width()}if(uploader.features.dragdrop&&!self.params.browser.mobile){container.addClass("drag-drop");drop_element.bind("dragover.wp-uploader",function(){container.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){container.removeClass("drag-over")})}else{container.removeClass("drag-drop");drop_element.unbind(".wp-uploader")}});this.uploader.bind("postinit",function(up){up.refresh()});this.uploader.init();this.feedback=function(message,data,file){if(!_.isNull(file)&&file.item){file.item.clear()}bp.Uploader.filesError.unshift({message:message,data:data,file:file})};this.uploader.bind("FilesAdded",function(uploader,files){var hundredmb=100*1024*1024,max=parseInt(uploader.settings.max_file_size,10),_this=this;if(!uploader.settings.multi_selection&&files.length>1){for(var i in files){uploader.removeFile(files[i])}$(self).trigger("sz-uploader-warning",self.strings.unique_file_warning);return}_.each(files,function(file){var attributes;if(plupload.FAILED===file.status){return}if(max>hundredmb&&file.size>hundredmb&&uploader.runtime!=="html5"){_this.uploadSizeError(uploader,file,true)}else{attributes=_.extend({id:file.id,file:file,uploading:true,date:new Date,filename:file.name},_.pick(file,"loaded","size","percent"));file.item=new bp.Models.File(attributes);bp.Uploader.filesQueue.add(file.item)}});uploader.refresh();uploader.start()});this.uploader.bind("UploadProgress",function(uploader,file){file.item.set(_.pick(file,"loaded","percent"))});this.uploader.bind("FileUploaded",function(uploader,file,response){var message=self.strings.default_error;try{response=JSON.parse(response.response)}catch(e){return self.feedback(message,e,file)}if(!_.isObject(response)||_.isUndefined(response.success)){return self.feedback(message,null,file)}else if(!response.success){if(response.data&&response.data.message){message=response.data.message}return self.feedback(message,response.data,file)}_.each(["file","loaded","size","percent"],function(key){file.item.unset(key)});file.item.set(_.extend(response.data,{uploading:false}));bp.Uploader.filesUploaded.add(file.item)});this.uploader.bind("BeforeUpload",function(uploader,files){$(self).trigger("sz-uploader-new-upload",uploader,files)});this.uploader.bind("UploadComplete",function(uploader,files){$(self).trigger("sz-uploader-upload-complete",uploader,files);bp.Uploader.filesQueue.reset()});this.uploader.bind("Error",function(uploader,pluploadError){var message=self.strings.default_error,key,errors={FAILED:self.strings.upload_failed,FILE_EXTENSION_ERROR:self.strings.invalid_filetype,IMAGE_FORMAT_ERROR:self.strings.not_an_image,IMAGE_MEMORY_ERROR:self.strings.image_memory_exceeded,IMAGE_DIMENSIONS_ERROR:self.strings.image_dimensions_exceeded,GENERIC_ERROR:self.strings.upload_failed,IO_ERROR:self.strings.io_error,HTTP_ERROR:self.strings.http_error,SECURITY_ERROR:self.strings.security_error,FILE_SIZE_ERROR:self.strings.file_exceeds_size_limit.replace("%s",$("<span />").text(pluploadError.file.name).html())};for(key in errors){if(pluploadError.code===plupload[key]){message=errors[key];break}}$(self).trigger("sz-uploader-warning",message);uploader.refresh()})};bp.Models.File=Backbone.Model.extend({file:{}});$.extend(bp.Uploader,{filesQueue:new Backbone.Collection,filesUploaded:new Backbone.Collection,filesError:new Backbone.Collection});bp.View=bp.Backbone.View.extend({inject:function(selector){this.render();$(selector).html(this.el);this.views.ready()},prepare:function(){if(!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)){return this.model.toJSON()}else{return{}}}});bp.Views.Uploader=bp.View.extend({className:"sz-uploader-window",template:bp.template("upload-window"),defaults:_.pick(SZ_Uploader.settings.defaults,"container","drop_element","browse_button"),initialize:function(){this.warnings=[];this.model=new Backbone.Model(this.defaults);this.on("ready",this.initUploader)},initUploader:function(){this.uploader=new bp.Uploader.uploader;$(this.uploader).on("sz-uploader-warning",_.bind(this.setWarning,this));$(this.uploader).on("sz-uploader-new-upload",_.bind(this.resetWarning,this))},setWarning:function(event,message){if(_.isUndefined(message)){return}var warning=new bp.Views.uploaderWarning({value:message}).render();this.warnings.push(warning);this.$el.after(warning.el)},resetWarning:function(){if(0===this.warnings.length){return}_.each(this.warnings,function(view){view.remove()});this.warnings=[]}});bp.Views.uploaderWarning=bp.View.extend({tagName:"p",className:"warning",initialize:function(){this.value=this.options.value},render:function(){this.$el.html(this.value);return this}});bp.Views.uploaderStatus=bp.View.extend({className:"files",initialize:function(){_.each(this.collection.models,this.addFile,this);this.collection.on("change:percent",this.progress,this);bp.Uploader.filesError.on("add",this.feedback,this)},addFile:function(file){this.views.add(new bp.Views.uploaderProgress({model:file}))},progress:function(model){if(!_.isUndefined(model.get("percent"))){$("#"+model.get("id")+" .sz-progress .sz-bar").css("width",model.get("percent")+"%")}},feedback:function(model){if(!_.isUndefined(model.get("message"))&&!_.isUndefined(model.get("file"))){$("#"+model.get("file").id).html(model.get("message")).addClass("error")}}});bp.Views.uploaderProgress=bp.View.extend({className:"sz-uploader-progress",template:bp.template("progress-window")})})(bp,jQuery);