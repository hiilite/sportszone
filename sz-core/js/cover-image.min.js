window.bp=window.bp||{};(function(exports,$){if(typeof SZ_Uploader==="undefined"){return}bp.Models=bp.Models||{};bp.Collections=bp.Collections||{};bp.Views=bp.Views||{};bp.CoverImage={start:function(){var self=this;this.removeLegacyUI();this.views=new Backbone.Collection;this.jcropapi={};this.warning=null;this.setupNav();this.coverImages=bp.Uploader.filesUploaded;this.Attachment=new Backbone.Model;bp.Uploader.filesQueue.on("reset",this.cropView,this);$("body.wp-admin").on("tb_unload","#TB_window",function(){self.resetViews()});$("body.wp-admin").on("click",".sz-xprofile-cover-image-user-edit",function(){self.resetViews()})},removeLegacyUI:function(){if($("#cover-image-upload-form").length){$("#cover-image-upload").remove();$("#cover-image-upload-form p").remove()}else if($("#group-settings-form").length){$("#group-settings-form p").each(function(i){if(0!==i){$(this).remove()}});if($("#delete-group-cover-image-button").length){$("#delete-group-cover-image-button").remove()}}else if($("#group-create-body").length){$(".main-column p #file").remove();$(".main-column p #upload").remove()}else if($("#sz_xprofile_user_admin_cover_image a.sz-xprofile-cover-image-user-admin").length){$("#sz_xprofile_user_admin_cover_image a.sz-xprofile-cover-image-user-admin").remove()}},setView:function(view){if(!_.isUndefined(this.views.models)){_.each(this.views.models,function(model){model.get("view").remove()},this)}this.views.reset();if(!_.isUndefined(this.coverImages)){this.coverImages.reset()}if(!_.isEmpty(this.jcropapi)){this.jcropapi.destroy();this.jcropapi={}}switch(view){case"upload":this.uploaderView();break;case"delete":this.deleteView();break}},resetViews:function(){this.nav.trigger("sz-cover-image-view:changed","upload");_.each(this.navItems.models,function(model){if(model.id==="upload"){model.set({active:1})}else{model.set({active:0})}})},setupNav:function(){var self=this,initView,activeView;this.navItems=new Backbone.Collection;_.each(SZ_Uploader.settings.nav,function(item,index){if(!_.isObject(item)){return}activeView=0;if(0===index){initView=item.id;activeView=1}self.navItems.add({id:item.id,name:item.caption,href:"#",active:activeView,hide:_.isUndefined(item.hide)?0:item.hide})});this.nav=new bp.Views.Nav({collection:this.navItems});this.nav.inject(".sz-cover-image-nav");this.setView(initView);this.nav.on("sz-cover-image-view:changed",_.bind(this.setView,this))},uploaderView:function(){bp.Uploader.filesQueue.on("add",this.uploadProgress,this);var uploader=new bp.Views.Uploader;this.views.add({id:"upload",view:uploader});uploader.inject(".sz-cover-image")},uploadProgress:function(){var coverImageStatus=new bp.Views.uploaderStatus({collection:bp.Uploader.filesQueue});if(!_.isUndefined(this.views.get("status"))){this.views.set({id:"status",view:coverImageStatus})}else{this.views.add({id:"status",view:coverImageStatus})}coverImageStatus.inject(".sz-cover-image-status")},cropView:function(){var status;if(_.isEmpty(this.coverImages.models)){return}if(!_.isUndefined(this.views.get("status"))){status=this.views.get("status");status.get("view").remove();this.views.remove({id:"status",view:status})}var cover_image=new bp.Views.CoverImages({collection:this.coverImages});this.views.add({id:"crop",view:cover_image});cover_image.inject(".sz-cover-image")},setCoverImage:function(cover_image){var self=this,crop;if(!_.isUndefined(this.views.get("crop"))){if(!_.isEmpty(this.jcropapi)){this.jcropapi.destroy();this.jcropapi={}}crop=this.views.get("crop");crop.get("view").remove();this.views.remove({id:"crop",view:crop})}bp.ajax.post("sz_cover_image_set",{json:true,original_file:cover_image.get("url"),crop_w:cover_image.get("w"),crop_h:cover_image.get("h"),crop_x:cover_image.get("x"),crop_y:cover_image.get("y"),item_id:cover_image.get("item_id"),object:cover_image.get("object"),type:_.isUndefined(cover_image.get("type"))?"crop":cover_image.get("type"),nonce:cover_image.get("nonces").set}).done(function(response){var coverImageStatus=new bp.Views.CoverImageStatus({value:SZ_Uploader.strings.feedback_messages[response.feedback_code],type:"success"});self.views.add({id:"status",view:coverImageStatus});coverImageStatus.inject(".sz-cover-image-status");$("."+cover_image.get("object")+"-"+response.item_id+"-cover-image").each(function(){$(this).prop("src",response.cover_image)});bp.CoverImage.navItems.get("delete").set({hide:0});self.Attachment.set(_.extend(_.pick(cover_image.attributes,["object","item_id"]),{url:response.cover_image,action:"uploaded"}))}).fail(function(response){var feedback=SZ_Uploader.strings.default_error;if(!_.isUndefined(response)){feedback=SZ_Uploader.strings.feedback_messages[response.feedback_code]}var coverImageStatus=new bp.Views.CoverImageStatus({value:feedback,type:"error"});self.views.add({id:"status",view:coverImageStatus});coverImageStatus.inject(".sz-cover-image-status")})},deleteView:function(){var delete_model=new Backbone.Model(_.pick(SZ_Uploader.settings.defaults.multipart_params.sz_params,"object","item_id","nonces"));var deleteView=new bp.Views.DeleteCoverImage({model:delete_model});this.views.add({id:"delete",view:deleteView});deleteView.inject(".sz-cover-image")},deleteCoverImage:function(model){var self=this,deleteView;if(!_.isUndefined(this.views.get("delete"))){deleteView=this.views.get("delete");deleteView.get("view").remove();this.views.remove({id:"delete",view:deleteView})}bp.ajax.post("sz_cover_image_delete",{json:true,item_id:model.get("item_id"),object:model.get("object"),nonce:model.get("nonces").remove}).done(function(response){var coverImageStatus=new bp.Views.CoverImageStatus({value:SZ_Uploader.strings.feedback_messages[response.feedback_code],type:"success"});self.views.add({id:"status",view:coverImageStatus});coverImageStatus.inject(".sz-cover-image-status");$("."+model.get("object")+"-"+response.item_id+"-cover-image").each(function(){$(this).prop("src",response.cover_image)});bp.CoverImage.navItems.get("delete").set({active:0,hide:1});SZ_Uploader.settings.defaults.multipart_params.sz_params.has_cover_image=false;self.Attachment.set(_.extend(_.pick(model.attributes,["object","item_id"]),{url:response.reset_url,action:"deleted"}))}).fail(function(response){var feedback=SZ_Uploader.strings.default_error;if(!_.isUndefined(response)){feedback=SZ_Uploader.strings.feedback_messages[response.feedback_code]}var coverImageStatus=new bp.Views.CoverImageStatus({value:feedback,type:"error"});self.views.add({id:"status",view:coverImageStatus});coverImageStatus.inject(".sz-cover-image-status")})},removeWarning:function(){if(!_.isNull(this.warning)){this.warning.remove()}},displayWarning:function(message){this.removeWarning();this.warning=new bp.Views.uploaderWarning({value:message});this.warning.inject(".sz-cover-image-status")}};bp.Views.Nav=bp.View.extend({tagName:"ul",className:"cover-image-nav-items",events:{"click .sz-cover-image-nav-item":"toggleView"},initialize:function(){var hasCoverImage=_.findWhere(this.collection.models,{id:"delete"});if(1!==hasCoverImage.get("hide")){bp.CoverImage.displayWarning(SZ_Uploader.strings.has_cover_image_warning)}_.each(this.collection.models,this.addNavItem,this);this.collection.on("change:hide",this.showHideNavItem,this)},addNavItem:function(item){if(1===item.get("hide")){return}this.views.add(new bp.Views.NavItem({model:item}))},showHideNavItem:function(item){var isRendered=null;_.each(this.views._views[""],function(view){if(1===view.model.get("hide")){view.remove()}if(item.get("id")===view.model.get("id")){isRendered=true}});if(!_.isBoolean(isRendered)){this.addNavItem(item)}},toggleView:function(event){event.preventDefault();bp.CoverImage.removeWarning();var active=$(event.target).data("nav");_.each(this.collection.models,function(model){if(model.id===active){model.set({active:1});this.trigger("sz-cover-image-view:changed",model.id)}else{model.set({active:0})}},this)}});bp.Views.NavItem=bp.View.extend({tagName:"li",className:"cover-image-nav-item",template:bp.template("sz-cover-image-nav"),initialize:function(){if(1===this.model.get("active")){this.el.className+=" current"}this.el.id+="sz-cover-image-"+this.model.get("id");this.model.on("change:active",this.setCurrentNav,this)},setCurrentNav:function(model){if(1===model.get("active")){this.$el.addClass("current")}else{this.$el.removeClass("current")}}});bp.Views.CoverImages=bp.View.extend({className:"items",initialize:function(){_.each(this.collection.models,this.addItemView,this)},addItemView:function(item){var full_d={full_h:315,full_w:1300};if(!_.isUndefined(SZ_Uploader.settings.crop.full_h)&&!_.isUndefined(SZ_Uploader.settings.crop.full_w)){full_d.full_h=SZ_Uploader.settings.crop.full_h;full_d.full_w=SZ_Uploader.settings.crop.full_w}item.set(_.extend(_.pick(SZ_Uploader.settings.defaults.multipart_params.sz_params,"object","item_id","nonces"),full_d));this.views.add(new bp.Views.CoverImage({model:item}))}});bp.Views.CoverImage=bp.View.extend({className:"item",template:bp.template("sz-cover-image-item"),events:{"click .cover-image-crop-submit":"cropCoverImage"},initialize:function(){_.defaults(this.options,{full_h:SZ_Uploader.settings.crop.full_h,full_w:SZ_Uploader.settings.crop.full_w,aspectRatio:4.126984126984127});if(false!==this.model.get("feedback")){bp.CoverImage.displayWarning(this.model.get("feedback"))}console.log(this.options);this.on("ready",this.initCropper)},initCropper:function(){var self=this,tocrop=this.$el.find("#cover-image-to-crop img"),availableWidth=this.$el.width(),selection={},crop_top,crop_bottom,crop_left,crop_right,nh,nw;if(!_.isUndefined(this.options.full_h)&&!_.isUndefined(this.options.full_w)){this.options.aspectRatio=this.options.full_w/this.options.full_h}selection.w=$("#cover-image-to-crop").width();selection.h=selection.w*.2423;console.log(this);console.log(selection);if(selection.h<=selection.w){crop_top=0;nh=nw=Math.round(selection.h/2);crop_bottom=nh+crop_top;crop_left=0;crop_right=nw+crop_left}else{crop_left=0;nh=nw=Math.round(selection.w/2);crop_right=nw+crop_left;crop_top=0;crop_bottom=nh+crop_top}console.log(crop_left,crop_top,crop_right,crop_bottom);tocrop.Jcrop({onChange:_.bind(self.showPreview,self),onSelect:_.bind(self.showPreview,self),aspectRatio:self.options.aspectRatio,setSelect:[crop_left,crop_top,crop_right,crop_bottom]},function(){bp.CoverImage.jcropapi=this})},cropCoverImage:function(event){event.preventDefault();bp.CoverImage.setCoverImage(this.model)},showPreview:function(coords){if(!coords.w||!coords.h){return}if(parseInt(coords.w,10)>0){var fw=$("#cover-image-to-crop").width();var fh=fw*.2423;var rx=fw/coords.w;var ry=fh/coords.h;console.log(coords.x,coords.y,coords.w,coords.h);this.model.set({x:coords.x,y:coords.y,w:coords.w,h:coords.h});$("#cover-image-crop-preview").css({maxWidth:"none",width:Math.round(rx*this.model.get("width"))+"px",height:Math.round(ry*this.model.get("height"))+"px",marginLeft:"-"+Math.round(rx*this.model.get("x"))+"px",marginTop:"-"+Math.round(ry*this.model.get("y"))+"px"})}}});bp.Views.CoverImageStatus=bp.View.extend({tagName:"p",className:"updated",id:"sz-cover-image-feedback",initialize:function(){this.el.className+=" "+this.options.type;this.value=this.options.value},render:function(){this.$el.html(this.value);return this}});bp.Views.DeleteCoverImage=bp.View.extend({tagName:"div",id:"sz-delete-cover-image-container",template:bp.template("sz-cover-image-delete"),events:{"click #sz-delete-cover-image":"deleteCoverImage"},deleteCoverImage:function(event){event.preventDefault();bp.CoverImage.deleteCoverImage(this.model)}});bp.CoverImage.start()})(bp,jQuery);